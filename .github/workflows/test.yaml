---
name: autocommit
on: pull_request
jobs:
  test:
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - run: |
          echo "foo" > foo.txt
          mkdir -p bar
          echo "bar" > bar/bar.txt
          echo "zoo" > zoo.txt

      - id: artifact-name
        run: |
          value=$(tr -dc A-Za-z0-9 </dev/urandom | head -c 32)
          echo "value=autofix-${value}" >> "$GITHUB_OUTPUT"
      - id: files
        env:
          ARTIFACT_NAME: ${{ steps.artifact-name.outputs.value }}
        run: |
          FILES=$(git ls-files --modified --others --exclude-standard)
          if [ -z "$FILES" ]; then
            echo "::notice:: No changes" >&2
            exit 0
          fi
          {
            echo 'value<<EOF'
            echo "$FILES"
            echo "${ARTIFACT_NAME}.json"
            echo "${ARTIFACT_NAME}_files.txt"
            echo EOF
          } >> "$GITHUB_OUTPUT"
      - uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
        if: steps.files.outputs.value != ''
        id: token
        with:
          app_id: ${{vars.AUTOFIX_TRIGGER_APP_ID}}
          private_key: ${{secrets.AUTOFIX_TRIGGER_APP_PRIVATE_KEY}}
          repositories: >-
            ["autofix"]
          permissions: >-
            {
              "issues": "write"
            }
      - run: echo "$METADATA" > "${ARTIFACT_NAME}.json"
        if: steps.files.outputs.value != ''
        env:
          ARTIFACT_NAME: ${{ steps.artifact-name.outputs.value }}
          METADATA: |
            {
              "pull_request": {
                "number": "${{ github.event.number }}"
              }
            }
      - run: echo "$FILES" > "${ARTIFACT_NAME}_files.txt"
        if: steps.files.outputs.value != ''
        env:
          ARTIFACT_NAME: ${{ steps.artifact-name.outputs.value }}
          FILES: ${{ steps.files.outputs.value }}
      - uses: actions/upload-artifact@4cec3d8aa04e39d1a68397de0c4cd6fb9dce8ec1 # v4.6.1
        if: steps.files.outputs.value != ''
        with:
          name: ${{steps.artifact-name.outputs.value}}
          path: ${{ steps.files.outputs.value }}
      - run: rm "${ARTIFACT_NAME}.json" "${ARTIFACT_NAME}_files.txt"
        if: steps.files.outputs.value != ''
        env:
          ARTIFACT_NAME: ${{ steps.artifact-name.outputs.value }}
      - if: steps.files.outputs.value != ''
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          ARTIFACT_NAME: ${{ steps.artifact-name.outputs.value }}
        run: |
          gh label create \
            -R "${GITHUB_REPOSITORY_OWNER}/autofix" \
            "$ARTIFACT_NAME" \
            --description "$GITHUB_REPOSITORY/${GITHUB_RUN_ID}"
      - if: steps.files.outputs.value != ''
        run: sleep 1
      - if: steps.files.outputs.value != ''
        env:
          GH_TOKEN: ${{ steps.token.outputs.token }}
          ARTIFACT_NAME: ${{ steps.artifact-name.outputs.value }}
        run: |
          gh label delete \
            -R "${GITHUB_REPOSITORY_OWNER}/autofix" \
            --yes \
            "$ARTIFACT_NAME"
